// DB utility functions
var q = require('q');

// We need to use a table, make sure it's up and available.
function verifyDescribeTable(dynamodb, tableName, successResolveArg) {
    var defer = q.defer(),
        response;

    console.log('verifyDescribeTable: ' + tableName);

    // Make sure there is an active table
    dynamodb.describeTable({ TableName: tableName }, function(err, data) {
        if (err) {
            // It should have been created, something is wrong.
            console.log('describeTable(' + tableName + ') returned error: ' + JSON.stringify(err));
            response = {
                error: 'Cannot describe ' + tableName + ' table',
                code: 'PG_ERROR_DB_DESCRIBE'
            };
            defer.reject(response);
        } else if (!data || !data.Table || !data.Table.TableStatus) {
            // It should have been created, something is wrong.
            console.log('describeTable(' + tableName + ') returned no error, but no TableStatus ether');
            response = {
                error: 'Cannot describe ' + tableName + ' table',
                code: 'PG_ERROR_DB_DESCRIBE_GIBBERISH'
            };
            defer.reject(response);
        } else if (data.Table.TableStatus !== 'ACTIVE') {
            // It should have been created, something is wrong.
            console.log('describeTable(' + tableName + ') returned inactive table');
            response = {
                error: 'Table(' + tableName + ') not active',
                code: 'PG_ERROR_DB_DESCRIBE_NOT_ACTIVE'
            };
            defer.reject(response);
        } else {
            console.log('verifyDescribeTable resolving');
            defer.resolve(successResolveArg);
        }
    });

    return defer.promise;
}

function validateSession(dynamodb, sessionHash) {
    var defer = q.defer(),
        response;

    console.log('validateSession: ' + sessionHash);

    if (!sessionHash) {
        console.log('Session cannot be validated: User is not logged in');
        response = {
            error: 'You must be logged in to perform this action',
            code: 'PG_ERROR_NO_SESSION'
        };
        defer.reject(response);
    } else {
        this.getItem(dynamodb, 'session', 'sessionHash', sessionHash)
        .then(function(session) {
            if (!session || session.sessionHash !== sessionHash) {
                console.log('validateSession(' + sessionHash + ') failed, no match');
                response = {
                    error: 'Cannot get session',
                    code: 'PG_ERROR_DB_SESSION_NOT_FOUND'
                };
                defer.reject(response);
            } else {
                defer.resolve(session);
            }

        })
        .fail(function(err) {
            defer.reject(err);
        });
    }

    return defer.promise;
}

function validatePlayer(dynamodb, sessionHash) {
    var self = this;
    console.log('validatePlayer with sessionHash: ' + sessionHash);
    return this.validateSession(dynamodb, sessionHash)
    .then(function(session) {
        console.log('validatePlayer got session, getting player "' + session.username + '"');
        return self.getItem(dynamodb, 'player', 'username', session.username);
    });
}

function getItem(dynamodb, tableName, keyName, keyValue) {
    var defer = q.defer(),
        response,
        params = { TableName: tableName, Key: {}};

    params.Key[keyName] = keyValue;

    console.log('getItem from table ' + tableName);
    console.log(JSON.stringify(params));

    dynamodb.getItem(params, function(err, data) {
        if (err) {
            console.log('getItem from table "' + tableName + '" returned error: ' + JSON.stringify(err));
            response = {
                error: 'Cannot get item from table ' + tableName,
                code: 'PG_ERROR_DB_GET_' + tableName.toUpperCase()
            };
            defer.reject(response);
        } else  if (!data) {
            console.log('getItem from table "' + tableName + '" returned gibberish');
            console.log('data: ' + JSON.stringify(data));
            response = {
                error: 'Cannot get session',
                code: 'PG_ERROR_DB_GET_' + tableName.toUpperCase() + '_GIBBERISH'
            };
            defer.reject(response);
        } else {
            console.log('getItem from table "' + tableName + '" resolved with item');
            defer.resolve(data.Item || {});
        }
    });

    return defer.promise;
}

function putItem(dynamodb, tableName, item) {
    var defer = q.defer(),
        response,
        params = { TableName: tableName, Item: item};

    console.log('putItem into table ' + tableName);
    console.log(JSON.stringify(item));

    dynamodb.putItem(params, function(err, data) {
        if (err) {
            console.log('Cannot put item into table ' + tableName + ': ' + JSON.stringify(err));
            response = {
                error: 'Cannot write to table ' + tableName,
                code: 'PG_ERROR_DB_PUTITEM'
            };
            defer.reject(response);
        }
        defer.resolve();
    });

    return defer.promise;
}

module.exports = {
    getItem: getItem,
    putItem: putItem,

    verifyDescribeTable: verifyDescribeTable,
    validateSession: validateSession,
    validatePlayer: validatePlayer,
};

