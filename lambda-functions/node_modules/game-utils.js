var dbUtils = require('db-utils'),
  aws = require('aws-sdk'),
  pg = require('pg'),
  q = require('q');

function createNewDeal(dynamodb, game, dealIndex) {
  console.log('creating new deal');
  deal = pg.newDeal(game.gameHash,  dealIndex);
  console.log('new deal: ');
  console.log(deal);
  return q.all([
      dbUtils.putItem(dynamodb, 'deal', deal),
      dbUtils.putItem(dynamodb, 'game', game)
  ]).then (function() {
    return deal;
  });
}

function haveComputerSetTiles(sessionHash, opponent, deal) {
    console.log('setting tiles for opponent: ' + opponent);
    var lambda = new aws.Lambda(),
      defer = q.defer();
    var params = {
        FunctionName: 'pg-lambda-set-tiles-for-deal',
        // ClientContext: 'STRING_VALUE',
        InvocationType: 'Event', // 'Event | RequestResponse | DryRun',
        LogType: 'None', // 'None | Tail',
        Payload: // new Buffer('...') || 'STRING_VALUE',
            JSON.stringify({
                sessionHash: sessionHash,
                dealID: deal.dealID
            })
        // Qualifier: 'STRING_VALUE'
    };
    console.log('created lambda params:');
    console.log(params);
    lambda.invoke(params, function(err, data) {
        if (err) {
            console.log('Lambda error:');
            console.log(err, err.stack); // an error occurred
            defer.resolve();    // TODO: wtf do we do here?
        } else {
            console.log('Lambda success:');
            console.log(data);           // successful response
            defer.resolve();
        }
    });

    return defer.promise;
}

module.exports = {
    createNewDeal: createNewDeal,
    haveComputerSetTiles: haveComputerSetTiles
};
